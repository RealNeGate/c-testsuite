#! /usr/bin/env bash

set -e
set -u

t=$1

cat $t

set -x

if ! valgrind --leak-check=no -q 9cc "$t" > "$t.s"
then
    exit 1
fi

if ! gcc -o "$t.bin" "$t.s"
then
    exit 1
fi

if ! "$t.bin" > "t.output"
then
    exit 1
fi

if test -f "$t.expected"
then
    if ! diff -u "$t.expected" "$t.output"
    then
        exit 1
    fi
fi
